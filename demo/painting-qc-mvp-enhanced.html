<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic QC System - Commercial Painting MVP</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Excel Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent-color: #667eea;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #3b82f6;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
        }

        * { transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }

        /* –ü—Ä–∏–º–µ–Ω—è–µ–º CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ –≤—Å–µ–º —ç–ª–µ–º–µ–Ω—Ç–∞–º */
        .bg-white { background-color: var(--bg-secondary) !important; }
        .bg-gray-50 { background-color: var(--bg-primary) !important; }

        .text-gray-800, .text-gray-900 { color: var(--text-primary) !important; }
        .text-gray-600, .text-gray-500 { color: var(--text-secondary) !important; }

        .border-gray-300, .border-gray-200, .divide-gray-200 { border-color: var(--border-color) !important; }

        input, select, textarea {
            background-color: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--accent-color) !important;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1) !important;
        }

        .hover\:bg-gray-50:hover { background-color: #374151 !important; }

        /* –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
        [data-theme="dark"] table { color: var(--text-primary); }
        [data-theme="dark"] thead { background-color: var(--bg-primary) !important; }
        [data-theme="dark"] tbody { background-color: var(--bg-secondary) !important; }

        body { background-color: var(--bg-primary); color: var(--text-primary); }

        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow {
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card-shadow:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .animate-slide-in { animation: slideIn 0.5s ease-out; }
        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .animate-fade-in { animation: fadeIn 0.6s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .counter-animation {
            font-variant-numeric: tabular-nums;
            transition: all 0.3s ease;
        }

        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .workflow-line {
            background: linear-gradient(90deg, #4f46e5, #06b6d4, #10b981);
            height: 4px;
        }

        .status-badge {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .status-badge:hover {
            transform: scale(1.05);
        }

        .interactive-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .interactive-row:hover {
            background-color: var(--bg-primary);
            transform: scale(1.01);
        }

        .theme-toggle {
            position: relative;
            width: 60px;
            height: 30px;
            background: #374151;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .theme-toggle.active {
            background: #3b82f6;
        }
        .theme-toggle::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        .theme-toggle.active::after {
            transform: translateX(30px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            z-index: 1100;
            animation: toastSlideIn 0.3s ease-out;
        }

        @keyframes toastSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .filter-active {
            background: var(--accent-color) !important;
            color: white !important;
        }

        .upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .upload-zone:hover {
            border-color: var(--accent-color);
            background-color: rgba(59, 130, 246, 0.05);
        }
        .upload-zone.dragover {
            border-color: var(--accent-color);
            background-color: rgba(59, 130, 246, 0.1);
            transform: scale(1.02);
        }

        .photo-item {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .photo-item:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .photo-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .photo-item:hover .remove-btn {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans" x-data="qcSystem()" x-init="init()">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-paint-brush text-2xl"></i>
                    <h1 class="text-2xl font-bold">Dynamic QC System</h1>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <button @click="activeView = 'overview'"
                            :class="activeView === 'overview' ? 'text-yellow-300' : 'text-white hover:text-yellow-200'"
                            class="transition-colors">Overview</button>
                    <button @click="activeView = 'mobile'"
                            :class="activeView === 'mobile' ? 'text-yellow-300' : 'text-white hover:text-yellow-200'"
                            class="transition-colors">Mobile Checklist</button>
                    <button @click="activeView = 'dashboard'"
                            :class="activeView === 'dashboard' ? 'text-yellow-300' : 'text-white hover:text-yellow-200'"
                            class="transition-colors">Management Dashboard</button>
                    <button @click="activeView = 'workflow'"
                            :class="activeView === 'workflow' ? 'text-yellow-300' : 'text-white hover:text-yellow-200'"
                            class="transition-colors">Workflow</button>
                </nav>
                <div class="flex items-center space-x-4">
                    <div class="theme-toggle" @click="toggleTheme()" :class="{ 'active': darkMode }"></div>
                    <div class="relative">
                        <i class="fas fa-bell text-xl cursor-pointer" @click="showNotifications = !showNotifications"></i>
                        <span class="absolute -top-2 -right-2 bg-red-500 text-xs rounded-full h-5 w-5 flex items-center justify-center counter-animation" x-text="notifications.length"></span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Notifications Panel -->
    <div x-show="showNotifications" x-transition class="fixed top-16 right-4 bg-white rounded-lg shadow-xl p-4 w-80 z-50">
        <div class="flex items-center justify-between mb-3">
            <h3 class="font-bold text-gray-800">Recent Notifications</h3>
            <button @click="markAllAsRead()" class="text-sm text-blue-600 hover:text-blue-800">Mark all read</button>
        </div>
        <template x-for="notification in notifications" :key="notification.id">
            <div class="flex items-start space-x-3 p-2 hover:bg-gray-50 rounded cursor-pointer" @click="handleNotificationClick(notification)">
                <i :class="notification.icon" class="text-orange-500 mt-1"></i>
                <div class="flex-1">
                    <p class="text-sm font-medium" x-text="notification.title"></p>
                    <p class="text-xs text-gray-500" x-text="notification.time"></p>
                </div>
                <button @click.stop="removeNotification(notification.id)" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xs"></i>
                </button>
            </div>
        </template>
        <div x-show="notifications.length === 0" class="text-center text-gray-500 py-4">
            <i class="fas fa-bell-slash text-2xl mb-2"></i>
            <p class="text-sm">No new notifications</p>
        </div>
    </div>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">

        <!-- Mobile Checklist Section -->
        <div x-show="activeView === 'mobile'" class="animate-fade-in">
            <div class="max-w-md mx-auto">
                <div class="bg-white rounded-xl shadow-xl overflow-hidden">
                    <!-- Mobile Header -->
                    <div class="gradient-bg text-white p-4">
                        <div class="flex items-center space-x-3">
                            <i class="fas fa-paint-brush text-xl"></i>
                            <div>
                                <h3 class="font-bold">Quality Control Checklist</h3>
                                <p class="text-sm opacity-90">Job #12345 - Midpoint Inspection</p>
                            </div>
                        </div>
                    </div>

                    <!-- Form Content -->
                    <div class="p-6 space-y-6">
                        <!-- Job Info -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="font-semibold mb-2">Job Information</h4>
                            <div class="space-y-2 text-sm">
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Client:</span>
                                    <span class="font-medium">ABC Corporation</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Location:</span>
                                    <span class="font-medium">Building A, Floor 3</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Lead Painter:</span>
                                    <span class="font-medium">Mike Rodriguez</span>
                                </div>
                            </div>
                        </div>

                        <!-- Photo Upload -->
                        <div>
                            <h4 class="font-semibold mb-3">Required Photos</h4>

                            <!-- Upload Zone -->
                            <div class="upload-zone mb-4"
                                 @drop="handleDrop($event)"
                                 @dragover.prevent="$event.currentTarget.classList.add('dragover')"
                                 @dragleave.prevent="$event.currentTarget.classList.remove('dragover')"
                                 @click="$refs.fileInput.click()">
                                <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-2"></i>
                                <p class="text-lg font-medium mb-1">Drop photos here or click to upload</p>
                                <p class="text-sm text-gray-500">Support: JPG, PNG, GIF (max 10MB each)</p>
                                <input type="file"
                                       x-ref="fileInput"
                                       multiple
                                       accept="image/*"
                                       @change="handleFiles($event)"
                                       class="hidden">
                            </div>

                            <!-- Camera Capture -->
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <button @click="capturePhoto('wide')"
                                        class="border-2 border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors">
                                    <i class="fas fa-camera text-2xl text-blue-500 mb-2"></i>
                                    <p class="text-sm font-medium">Take Wide Shot</p>
                                </button>
                                <button @click="capturePhoto('detail')"
                                        class="border-2 border-gray-300 rounded-lg p-4 text-center hover:border-blue-500 transition-colors">
                                    <i class="fas fa-search-plus text-2xl text-blue-500 mb-2"></i>
                                    <p class="text-sm font-medium">Take Detail Shot</p>
                                </button>
                            </div>

                            <!-- Photo Gallery -->
                            <div x-show="uploadedPhotos.length > 0" class="mt-4">
                                <h5 class="font-medium mb-2" x-text="`Uploaded Photos (${uploadedPhotos.length})`"></h5>
                                <div class="grid grid-cols-3 gap-3">
                                    <template x-for="(photo, index) in uploadedPhotos" :key="index">
                                        <div class="photo-item">
                                            <img :src="photo.dataUrl"
                                                 class="w-full h-24 object-cover rounded"
                                                 :alt="photo.name"
                                                 @click="previewPhoto(photo)">
                                            <button @click="removePhoto(index)"
                                                    class="remove-btn">
                                                <i class="fas fa-times text-xs"></i>
                                            </button>
                                            <p class="text-xs text-center mt-1 truncate" x-text="photo.name"></p>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Button -->
                        <button class="w-full bg-blue-600 text-white py-3 rounded-lg font-semibold hover:bg-blue-700 transition-colors" @click="submitInspection()">
                            Submit Inspection
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Management Dashboard -->
        <div x-show="activeView === 'dashboard'" class="animate-fade-in">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-4">Management Dashboard</h2>
                <div class="flex justify-between items-center">
                    <p class="text-gray-600">Real-time overview of all quality control inspections and job status.</p>
                    <button @click="exportToExcel()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-colors">
                        <i class="fas fa-file-excel mr-2"></i>Export Excel
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid md:grid-cols-4 gap-6 mb-8">
                <div class="rounded-xl p-6 card-shadow cursor-pointer" @click="filterProjects('all')" style="background-color: var(--bg-secondary);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Active Jobs</p>
                            <p class="text-2xl font-bold text-blue-600 counter-animation" x-text="stats.active"></p>
                        </div>
                        <div class="relative">
                            <i class="fas fa-briefcase text-2xl text-blue-400"></i>
                            <div class="absolute -top-1 -right-1 w-3 h-3 bg-blue-500 rounded-full pulse"></div>
                        </div>
                    </div>
                </div>
                <div class="rounded-xl p-6 card-shadow cursor-pointer" @click="filterProjects('billing-ready')" style="background-color: var(--bg-secondary);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Billing Ready</p>
                            <p class="text-2xl font-bold text-green-600 counter-animation" x-text="stats.billingReady"></p>
                        </div>
                        <i class="fas fa-check-circle text-2xl text-green-400"></i>
                    </div>
                </div>
                <div class="rounded-xl p-6 card-shadow cursor-pointer" @click="filterProjects('pending-review')" style="background-color: var(--bg-secondary);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Pending Review</p>
                            <p class="text-2xl font-bold text-orange-600 counter-animation" x-text="stats.pendingReview"></p>
                        </div>
                        <i class="fas fa-clock text-2xl text-orange-400"></i>
                    </div>
                </div>
                <div class="rounded-xl p-6 card-shadow cursor-pointer" @click="filterProjects('exception')" style="background-color: var(--bg-secondary);">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600">Exceptions</p>
                            <p class="text-2xl font-bold text-red-600 counter-animation" x-text="stats.exceptions"></p>
                        </div>
                        <i class="fas fa-exclamation-triangle text-2xl text-red-400"></i>
                    </div>
                </div>
            </div>

            <!-- Jobs Table -->
            <div class="rounded-xl card-shadow overflow-hidden" style="background-color: var(--bg-secondary);">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead style="background-color: var(--bg-primary);">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Job #</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Client</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lead Painter</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Last Update</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="project in filteredProjects" :key="project.id">
                                <tr class="interactive-row" @click="openProjectModal(project)">
                                    <td class="px-6 py-4 whitespace-nowrap font-medium text-blue-600" x-text="'#' + project.id"></td>
                                    <td class="px-6 py-4 whitespace-nowrap" x-text="project.client"></td>
                                    <td class="px-6 py-4 whitespace-nowrap" x-text="project.painter"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                                <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" :style="`width: ${project.progress}%`"></div>
                                            </div>
                                            <span x-text="project.progress + '%'"></span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge px-2 py-1 text-xs font-semibold rounded-full"
                                              :class="getStatusColor(project.status)"
                                              x-text="getStatusText(project.status)"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500" x-text="project.lastUpdate"></td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <button class="text-blue-600 hover:text-blue-800 mr-3" @click.stop="openProjectModal(project)" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="text-green-600 hover:text-green-800 mr-2" @click.stop="downloadReport(project)" title="Download PDF Report">
                                            <i class="fas fa-file-pdf"></i>
                                        </button>
                                        <button class="text-orange-600 hover:text-orange-800" @click.stop="updateStatus(project)" title="Update Status" x-show="project.status !== 'billing-ready'">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <!-- Project Modal -->
    <div x-show="showModal" class="modal-overlay" @click="closeModal()" x-transition>
        <div class="modal-content" @click.stop>
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold" x-text="'Project #' + (selectedProject?.id || '')"></h3>
                    <button @click="closeModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <div x-show="selectedProject" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Client</label>
                            <p class="text-gray-900" x-text="selectedProject?.client"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Lead Painter</label>
                            <p class="text-gray-900" x-text="selectedProject?.painter"></p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Status</label>
                            <span class="status-badge px-2 py-1 text-xs font-semibold rounded-full"
                                  :class="getStatusColor(selectedProject?.status)"
                                  x-text="getStatusText(selectedProject?.status)"></span>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Progress</label>
                            <div class="flex items-center mt-1">
                                <div class="w-full bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-blue-600 h-2 rounded-full transition-all duration-300" :style="`width: ${selectedProject?.progress || 0}%`"></div>
                                </div>
                                <span class="text-sm" x-text="(selectedProject?.progress || 0) + '%'"></span>
                            </div>
                        </div>
                    </div>

                    <div class="flex space-x-3">
                        <button class="flex-1 bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors" @click="updateProjectStatus()">
                            <i class="fas fa-edit mr-2"></i>Update Status
                        </button>
                        <button class="flex-1 bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors" @click="downloadReport(selectedProject)">
                            <i class="fas fa-file-pdf mr-2"></i>Download PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div x-show="toastMessage" x-transition class="toast">
        <div class="flex items-center space-x-3">
            <i :class="toastIcon" class="text-lg"></i>
            <p x-text="toastMessage"></p>
        </div>
    </div>

    <!-- Photo Preview Modal -->
    <div x-show="showPhotoPreview" class="modal-overlay" @click="closePhotoPreview()" x-transition>
        <div class="modal-content max-w-4xl" @click.stop>
            <div class="p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xl font-bold">Photo Preview</h3>
                    <button @click="closePhotoPreview()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div x-show="currentPreviewPhoto" class="text-center">
                    <img :src="currentPreviewPhoto?.dataUrl" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                    <div class="mt-4 space-y-2">
                        <p class="font-medium" x-text="currentPreviewPhoto?.name"></p>
                        <p class="text-sm text-gray-500">Size: <span x-text="formatFileSize(currentPreviewPhoto?.size)"></span></p>
                        <p class="text-sm text-gray-500">Type: <span x-text="currentPreviewPhoto?.type"></span></p>
                    </div>
                    <div class="mt-4 flex justify-center space-x-3">
                        <button @click="downloadPhoto(currentPreviewPhoto)"
                                class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">
                            <i class="fas fa-download mr-2"></i>Download
                        </button>
                        <button @click="removePhotoFromPreview()"
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Remove
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function qcSystem() {
            return {
                activeView: 'mobile',
                showNotifications: false,
                showModal: false,
                selectedProject: null,
                darkMode: false,
                toastMessage: '',
                toastIcon: '',
                uploadedPhotos: [],
                showPhotoPreview: false,
                currentPreviewPhoto: null,

                filters: {
                    status: '',
                    painter: '',
                    date: ''
                },

                stats: {
                    active: 0,
                    billingReady: 0,
                    pendingReview: 0,
                    exceptions: 0
                },

                notifications: [
                    { id: 1, title: 'Job #12345 marked as Billing Ready', time: '2 hours ago', icon: 'fas fa-check-circle', type: 'success' },
                    { id: 2, title: 'Exception flagged on Job #12347', time: '1 day ago', icon: 'fas fa-exclamation-triangle', type: 'warning' },
                    { id: 3, title: 'New inspection submitted by Mike Rodriguez', time: '3 hours ago', icon: 'fas fa-plus-circle', type: 'info' }
                ],

                projects: [
                    {
                        id: '12345',
                        client: 'ABC Corporation',
                        painter: 'Mike Rodriguez',
                        stage: '50%',
                        status: 'billing-ready',
                        progress: 50,
                        lastUpdate: '2 hours ago',
                        activities: [
                            { description: 'Quality inspection completed', time: '2 hours ago' },
                            { description: 'Photos uploaded to drive', time: '3 hours ago' },
                            { description: 'First coat application started', time: '1 day ago' }
                        ]
                    },
                    {
                        id: '12346',
                        client: 'XYZ Industries',
                        painter: 'Sarah Johnson',
                        stage: '100%',
                        status: 'pending-review',
                        progress: 100,
                        lastUpdate: '5 hours ago',
                        activities: [
                            { description: 'Final inspection submitted', time: '5 hours ago' },
                            { description: 'Cleanup completed', time: '6 hours ago' },
                            { description: 'Second coat applied', time: '1 day ago' }
                        ]
                    },
                    {
                        id: '12347',
                        client: 'Tech Solutions Ltd',
                        painter: 'David Chen',
                        stage: '30%',
                        status: 'exception',
                        progress: 30,
                        lastUpdate: '1 day ago',
                        activities: [
                            { description: 'Exception reported: Surface prep issues', time: '1 day ago' },
                            { description: 'Photo documentation added', time: '1 day ago' },
                            { description: 'Project paused for review', time: '1 day ago' }
                        ]
                    }
                ],

                filteredProjects: [],

                init() {
                    this.filteredProjects = this.projects;
                    this.updateStats();
                    this.animateCounters();

                    // Check for saved theme
                    if (localStorage.getItem('darkMode') === 'true') {
                        this.darkMode = true;
                        document.documentElement.setAttribute('data-theme', 'dark');
                    }
                },

                updateStats() {
                    this.stats.active = this.projects.length;
                    this.stats.billingReady = this.projects.filter(p => p.status === 'billing-ready').length;
                    this.stats.pendingReview = this.projects.filter(p => p.status === 'pending-review').length;
                    this.stats.exceptions = this.projects.filter(p => p.status === 'exception').length;
                },

                animateCounters() {
                    const counters = ['active', 'billingReady', 'pendingReview', 'exceptions'];
                    counters.forEach(counter => {
                        const target = this.stats[counter];
                        let current = 0;
                        const increment = target / 20;
                        const timer = setInterval(() => {
                            current += increment;
                            if (current >= target) {
                                current = target;
                                clearInterval(timer);
                            }
                            this.stats[counter] = Math.floor(current);
                        }, 50);
                    });
                },

                toggleTheme() {
                    this.darkMode = !this.darkMode;
                    if (this.darkMode) {
                        document.documentElement.setAttribute('data-theme', 'dark');
                    } else {
                        document.documentElement.removeAttribute('data-theme');
                    }
                    localStorage.setItem('darkMode', this.darkMode);
                    this.showToast('Theme updated', 'fas fa-palette');
                },

                filterProjects(status) {
                    if (status === 'all') {
                        this.filteredProjects = this.projects;
                    } else {
                        this.filteredProjects = this.projects.filter(p => p.status === status);
                    }
                    this.showToast(`Filtered by ${status}`, 'fas fa-filter');
                },

                getStatusColor(status) {
                    const colors = {
                        'billing-ready': 'bg-green-100 text-green-800',
                        'pending-review': 'bg-orange-100 text-orange-800',
                        'exception': 'bg-red-100 text-red-800',
                        'in-progress': 'bg-blue-100 text-blue-800'
                    };
                    return colors[status] || 'bg-gray-100 text-gray-800';
                },

                getStatusText(status) {
                    const texts = {
                        'billing-ready': 'Billing Ready',
                        'pending-review': 'Pending Review',
                        'exception': 'Exception',
                        'in-progress': 'In Progress'
                    };
                    return texts[status] || status;
                },

                openProjectModal(project) {
                    this.selectedProject = project;
                    this.showModal = true;
                },

                closeModal() {
                    this.showModal = false;
                    this.selectedProject = null;
                },

                updateProjectStatus() {
                    if (this.selectedProject) {
                        const statuses = ['in-progress', 'pending-review', 'billing-ready'];
                        const currentIndex = statuses.indexOf(this.selectedProject.status);
                        const nextIndex = (currentIndex + 1) % statuses.length;
                        this.selectedProject.status = statuses[nextIndex];
                        this.updateStats();
                        this.showToast(`Status updated to ${this.getStatusText(this.selectedProject.status)}`, 'fas fa-check');
                    }
                },

                downloadReport(project) {
                    try {
                        const { jsPDF } = window.jsPDF;
                        const doc = new jsPDF();

                        // Header
                        doc.setFontSize(20);
                        doc.setTextColor(102, 126, 234);
                        doc.text('QC Inspection Report', 20, 30);

                        // Project Info
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.text(`Project #: ${project.id}`, 20, 50);
                        doc.text(`Client: ${project.client}`, 20, 60);
                        doc.text(`Lead Painter: ${project.painter}`, 20, 70);
                        doc.text(`Status: ${this.getStatusText(project.status)}`, 20, 80);
                        doc.text(`Progress: ${project.progress}%`, 20, 90);
                        doc.text(`Last Update: ${project.lastUpdate}`, 20, 100);

                        // Progress Bar
                        doc.setFillColor(220, 220, 220);
                        doc.rect(20, 110, 100, 5, 'F');
                        doc.setFillColor(59, 130, 246);
                        doc.rect(20, 110, project.progress, 5, 'F');

                        // Activities
                        doc.text('Recent Activities:', 20, 130);
                        let yPos = 140;
                        project.activities.forEach((activity, index) => {
                            if (yPos > 250) {
                                doc.addPage();
                                yPos = 30;
                            }
                            doc.setFontSize(10);
                            doc.text(`‚Ä¢ ${activity.description} (${activity.time})`, 25, yPos);
                            yPos += 10;
                        });

                        // Photos section
                        if (this.uploadedPhotos.length > 0) {
                            yPos += 10;
                            doc.setFontSize(12);
                            doc.text('Attached Photos:', 20, yPos);
                            yPos += 15;

                            this.uploadedPhotos.forEach((photo, index) => {
                                if (yPos > 250) {
                                    doc.addPage();
                                    yPos = 30;
                                }
                                doc.setFontSize(10);
                                doc.text(`${index + 1}. ${photo.name} (${this.formatFileSize(photo.size)})`, 25, yPos);
                                yPos += 10;
                            });
                        }

                        // Footer
                        const pageCount = doc.internal.getNumberOfPages();
                        for (let i = 1; i <= pageCount; i++) {
                            doc.setPage(i);
                            doc.setFontSize(8);
                            doc.setTextColor(128, 128, 128);
                            doc.text(`Generated on ${new Date().toLocaleDateString()} | Page ${i} of ${pageCount}`,
                                    20, doc.internal.pageSize.height - 10);
                        }

                        // Save PDF
                        doc.save(`QC-Report-${project.id}-${new Date().toISOString().split('T')[0]}.pdf`);
                        this.showToast('‚úÖ PDF Report downloaded successfully!', 'fas fa-check-circle');

                    } catch (error) {
                        console.error('PDF generation error:', error);
                        this.showToast('‚ùå Error generating PDF. Please try again.', 'fas fa-exclamation-triangle');
                    }
                },

                updateStatus(project) {
                    this.openProjectModal(project);
                },

                markAllAsRead() {
                    this.notifications = [];
                    this.showToast('All notifications marked as read', 'fas fa-check');
                },

                removeNotification(id) {
                    this.notifications = this.notifications.filter(n => n.id !== id);
                },

                handleNotificationClick(notification) {
                    const projectId = notification.title.match(/#(\d+)/)?.[1];
                    if (projectId) {
                        const project = this.projects.find(p => p.id === projectId);
                        if (project) {
                            this.openProjectModal(project);
                            this.showNotifications = false;
                        }
                    }
                },

                // File handling methods
                handleDrop(e) {
                    e.preventDefault();
                    e.currentTarget.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    this.processFiles(files);
                },

                handleFiles(e) {
                    const files = Array.from(e.target.files);
                    this.processFiles(files);
                    e.target.value = ''; // Reset input
                },

                processFiles(files) {
                    files.forEach(file => {
                        if (file.type.startsWith('image/')) {
                            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                                this.showToast(`‚ùå File ${file.name} is too large (max 10MB)`, 'fas fa-exclamation-triangle');
                                return;
                            }

                            const reader = new FileReader();
                            reader.onload = (e) => {
                                this.uploadedPhotos.push({
                                    name: file.name,
                                    size: file.size,
                                    type: file.type,
                                    dataUrl: e.target.result,
                                    uploadDate: new Date().toLocaleString()
                                });
                                this.showToast(`‚úÖ Photo ${file.name} uploaded successfully`, 'fas fa-check');
                            };
                            reader.readAsDataURL(file);
                        } else {
                            this.showToast(`‚ùå File ${file.name} is not a valid image`, 'fas fa-exclamation-triangle');
                        }
                    });
                },

                capturePhoto(type) {
                    // For mobile devices - trigger camera
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = 'image/*';
                    input.capture = 'camera';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file) {
                            // Rename file based on type
                            const newFile = new File([file], `${type}-shot-${Date.now()}.jpg`, { type: file.type });
                            this.processFiles([newFile]);
                        }
                    };
                    input.click();
                },

                removePhoto(index) {
                    const photo = this.uploadedPhotos[index];
                    this.uploadedPhotos.splice(index, 1);
                    this.showToast(`üóëÔ∏è Photo ${photo.name} removed`, 'fas fa-trash');
                },

                previewPhoto(photo) {
                    this.currentPreviewPhoto = photo;
                    this.showPhotoPreview = true;
                },

                closePhotoPreview() {
                    this.showPhotoPreview = false;
                    this.currentPreviewPhoto = null;
                },

                downloadPhoto(photo) {
                    const link = document.createElement('a');
                    link.href = photo.dataUrl;
                    link.download = photo.name;
                    link.click();
                    this.showToast(`üì• Photo ${photo.name} downloaded`, 'fas fa-download');
                },

                removePhotoFromPreview() {
                    const index = this.uploadedPhotos.findIndex(p => p.name === this.currentPreviewPhoto.name);
                    if (index !== -1) {
                        this.removePhoto(index);
                    }
                    this.closePhotoPreview();
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                // Export data as Excel
                exportToExcel() {
                    try {
                        const ws = XLSX.utils.json_to_sheet(this.projects.map(p => ({
                            'Project ID': p.id,
                            'Client': p.client,
                            'Lead Painter': p.painter,
                            'Status': this.getStatusText(p.status),
                            'Progress': p.progress + '%',
                            'Stage': p.stage,
                            'Last Update': p.lastUpdate
                        })));

                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, 'QC Projects');
                        XLSX.writeFile(wb, `QC-Projects-${new Date().toISOString().split('T')[0]}.xlsx`);

                        this.showToast('‚úÖ Excel report exported successfully!', 'fas fa-file-excel');
                    } catch (error) {
                        console.error('Excel export error:', error);
                        this.showToast('‚ùå Error exporting Excel. Please try again.', 'fas fa-exclamation-triangle');
                    }
                },

                submitInspection() {
                    if (this.uploadedPhotos.length === 0) {
                        this.showToast('‚ùå Please upload at least one photo', 'fas fa-exclamation-triangle');
                        return;
                    }

                    // Simulate form submission
                    this.showToast('‚è≥ Submitting inspection...', 'fas fa-spinner');

                    setTimeout(() => {
                        this.showToast('‚úÖ Inspection submitted successfully!', 'fas fa-check-circle');
                        // Reset form
                        this.uploadedPhotos = [];
                    }, 2000);
                },

                showToast(message, icon) {
                    this.toastMessage = message;
                    this.toastIcon = icon;
                    setTimeout(() => {
                        this.toastMessage = '';
                    }, 4000);
                }
            }
        }
    </script>
</body>
</html>